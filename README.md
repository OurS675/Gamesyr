# GamesYr

GamesYr is a pirate-themed game search website that allows users to explore and discover games. The platform includes features for both regular users and administrators, providing a seamless experience for browsing and managing game content.

## Features

### User Features
- Search for games by name.
- Filter games by genre.
- View detailed information about each game, including images, descriptions, and links.

### Admin Features
- Add, edit, and delete games.
- Manage game images (add, remove, and edit).
- Organize game details, including genres, descriptions, and links.

## Technologies Used
- **React**: For building the user interface.
- **Vite**: As the development server and build tool.
- **CSS**: For styling the application.

## How to Run
1. Clone the repository:
   ```bash
   git clone https://github.com/OurS675/Gamesyr.git
   ```
2. Navigate to the project directory:
   ```bash
   cd Gamesyr
   ```
3. Install dependencies:
   ```bash
   npm install
   ```
4. Start the development server:
   ```bash
   npm run dev
   ```
5. Open your browser and go to `http://localhost:3000`.

## Supabase setup

1) Create a project in Supabase and copy the Project URL and anon/public API key.

2) Create an `.env` file at the project root with:

```
VITE_SUPABASE_URL=YOUR_SUPABASE_URL
VITE_SUPABASE_KEY=YOUR_SUPABASE_ANON_KEY
```

Restart the dev server after changing env vars.

3) Database tables (run in Supabase SQL editor):

```sql
-- Users table (app-level users with roles)
create table if not exists public.users (
  id uuid primary key default gen_random_uuid(),
  auth_user_id uuid unique,
  username text unique not null,
  email text unique not null,
  role text not null default 'user',
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

-- Games table used by Admin panel
create table if not exists public.games (
  id bigint generated by default as identity primary key,
  name text not null,
  links jsonb default '[]'::jsonb,
  image text default '',
  images text[] default '{}',
  description text default '',
  notes text default '',
  genre text default ''
);

-- Helpful index
create index if not exists idx_games_name on public.games using gin (to_tsvector('spanish', name));

-- RLS (required)
alter table public.users enable row level security;
alter table public.games enable row level security;

-- Role helper function
create or replace function public.is_admin() returns boolean language sql security definer set search_path = public as $$
  select exists (
    select 1 from public.users where auth_user_id = auth.uid() and role = 'admin'
  );
$$;

-- Games policies: public read, only admins write
drop policy if exists "games_read_all" on public.games;
drop policy if exists "games_admin_write" on public.games;
create policy "games_read_all" on public.games for select using (true);
create policy "games_admin_write" on public.games for all using (is_admin()) with check (is_admin());

-- Users table: owner can read/update their row; admins can access all
drop policy if exists users_select_self on public.users;
drop policy if exists users_insert_self on public.users;
drop policy if exists users_update_self on public.users;
create policy users_select_self on public.users for select using (auth.uid() = auth_user_id or is_admin());
create policy users_insert_self on public.users for insert with check (auth.uid() = auth_user_id or is_admin());
create policy users_update_self on public.users for update using (auth.uid() = auth_user_id or is_admin()) with check (auth.uid() = auth_user_id or is_admin());
```

### Promover usuario a admin

**Opción 1: Por email (recomendado)**
```sql
-- Reemplaza 'tu-email@ejemplo.com' con tu email real
update public.users set role = 'admin' where email = 'tu-email@ejemplo.com';
```

**Opción 2: Por auth_user_id**
```sql
-- Primero encuentra tu auth_user_id:
select auth_user_id, email, username, role from public.users where email = 'tu-email@ejemplo.com';

-- Luego promuévete (reemplaza el UUID):
update public.users set role = 'admin' where auth_user_id = 'TU_AUTH_USER_ID_AQUI';
```

**Opción 3: Crear admin desde cero**
```sql
-- Si no tienes usuario, regístrate primero, luego ejecuta:
insert into public.users (auth_user_id, username, email, role)
values ('REPLACE_WITH_AUTH_USER_ID', 'admin', 'admin@example.com', 'admin')
on conflict (auth_user_id) do update set role = 'admin';
```

**Función helper para promoción rápida:**
```sql
-- Función para promover cualquier usuario a admin por email
create or replace function promote_to_admin(user_email text) returns void as $$
begin
  update public.users set role = 'admin' where email = user_email;
  if not found then
    raise exception 'Usuario con email % no encontrado', user_email;
  end if;
end;
$$ language plpgsql security definer;

-- Uso: select promote_to_admin('tu-email@ejemplo.com');
```

### RLS simplificado para desarrollo

Si sigues teniendo problemas con RLS, usa esta configuración más permisiva para desarrollo:

```sql
-- Deshabilitar RLS temporalmente para debugging
alter table public.users disable row level security;
alter table public.games disable row level security;

-- O usar políticas muy permisivas
drop policy if exists users_select_self on public.users;
drop policy if exists users_insert_self on public.users;
drop policy if exists users_update_self on public.users;

-- Políticas permisivas para desarrollo
create policy users_allow_all on public.users for all using (true) with check (true);

-- Para games también
drop policy if exists "games_read_all" on public.games;
drop policy if exists "games_admin_write" on public.games;
create policy games_allow_all on public.games for all using (true) with check (true);
```

4) Storage bucket for images:

```sql
-- In Storage -> Buckets, create a public bucket named 'images'
-- Then, (optional) add storage policies if RLS is enforced in storage
```

5) Install dependencies (already in package.json):

```
npm i
```

6) Run the app:

```
npm run dev
```

If you update `.env`, restart the dev server.

### Notes
- Enable the Email provider in Supabase Authentication (Authentication -> Providers -> Email), configure SMTP or use "Confirm email" disabled only for local testing.
- 401 on `/rest/v1/users`: ensure RLS policies were applied and that you are authenticated; or create the profile row via trigger.
- 422/429 on `/auth/v1/signup`: avoid repeated signups with the same email; Supabase applies rate limiting. Wait a few minutes or use a different email.

### Optional: auto-create profile on signup (trigger)
```sql
create or replace function public.handle_new_user() returns trigger as $$
begin
  insert into public.users (auth_user_id, username, email)
  values (new.id, split_part(new.email, '@', 1), new.email)
  on conflict (auth_user_id) do nothing;
  return new;
end;
$$ language plpgsql security definer;

drop trigger if exists on_auth_user_created on auth.users;
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute function public.handle_new_user();
```

## License
This project is licensed under the MIT License.
